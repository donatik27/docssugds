---
sidebar_position: 30
title: Self-host a portal
description: Operate a client node
sidebar_class_name: hidden
---

# Self-host a portal

Running a portal enables you to access SQD Network data without relying on any centralized services. You can run a private portal for your own needs, or make a high-throughput public portal.

In either scenario you will need

* a working Docker installation
* some `SQD` tokens (in your wallet or in a special vesting contract)
* some Arbitrum ETH (for gas)

Hardware requirements depend on how the portal will be used. A private portal with a single user can run on a laptop.

## Token locking requirements and compute units {#staking-requirements-and-compute-units}

All portals have to be registered on-chain and have some `SQD` locked by their owner's wallet to begin serving requests. Amount of locked tokens and duration of the lockup determine the portal's bandwidth.

The minimum token locking requirement for a portal is XXX SQD. This should be enough for simple user cases like making a private portal for grabbing some data to do analytics. If you expect heavier workloads, read on.

The exact rate limiting mechanism is based on partitioning time into [_epochs_](/subsquid-network/faq/#epoch). Workers periodically [checks](https://arbiscan.io/address/0x4cf58097d790b193d22ed633bf8b15c9bc4f0da7#readContract#F4) if a new epoch has started (once every 30 seconds by default). When a worker receives its first (on the current epoch) request from a portal, it makes an [on-chain query](https://arbiscan.io/address/0x8a90a1ce5fa8cf71de9e6f76b7d3c0b72feb8c4b#readProxyContract#F6) for how many _compute units_ (CUs) are available for requests from the portal. The contract computes the number of CUs based on all locked tokens associated with the portal. The worker keeps the number and decrements it by one every time it receives more requests from the same portal. When the CUs are exhausted it begins replying to any new requests from the portal with HTTP 429 errors, which the portal forwards to the user. The cycle repeats once the worker detects that a new epoch has begun.

At present, any single data request to worker spends 1 CU. See e.g. [EVM worker API](/subsquid-network/reference/evm-api/#worker-api) to get an idea as to what the requests may look like. Portal concatenates the workers' responses into a single data stream.

By default, the contract allocates the same amount of CUs for each worker, namely
```
(SQD_AMOUNT * EPOCH_LENGTH * BOOST_FACTOR) / (NUM_WORKERS * NUM_PORTALS)
```
per epoch. Here,
 * `EPOCH_LENGTH` is 50000 Arbitrum blocks.
 * `BOOST_FACTOR` depends on the duration of the lockup, varying from 1 (lockups under 60 days) to 3 (720 or more days). See [Data consumers](/subsquid-network/whitepaper/#data-consumers) and [Boosters](/subsquid-network/whitepaper/#boosters) sections of the whitepaper.
 * `NUM_WORKERS` is the [number of workers active on the network](https://arbiscan.io/address/0x36e2b147db67e76ab67a4d07c293670ebefcae4e#readContract#F6).
 * `NUM_PORTALS` is the number of portals associated with the owner wallet.

:::info
It is possible to allocate CUs to workers selectively, e.g. to get more bandwidth on some datasets that are served by a subset workers. Currently there's only a low-level interface for this feature. If you're interested, please let us know in [SquidDevs Telegram chat](https://t.me/HydraDevs).
:::

For example, if you expect your portal to make up to 36k requests to any worker at any epoch, and the network currently has 1000 workers, you will need to lock 30000 SQD if you choose the shortest locking duration and 10000 SQD if you lock for two years or more.

:::tip
By default, your portal will go down at the end of the lock period. To prevent that, enable the "Auto-extension" option when locking. This will cause your `SQD` to be immediately relocked once the locking period ends. In this setup you have to unlock then wait for the end of the current locking period to withdraw your tokens.
:::

## Setting up a portal {#portal-setup}

#### Step 1: Lock some SQD {#lock-sqd}

* Go to [network.subsquid.io](https://network.subsquid.io) and connect your wallet (we recommend Metamask). Use the wallet that holds the tokens or is the beneficiary of your vesting contract.
* Go to the [portals page](https://network.subsquid.io/portals) and press the "Lock" button.
  ![Lock button](<./portal_lock_button.png>)
* Specify the amount of `SQD` you want to lock and the duration of the lockup.
  ![Lockup form](./portal_lock_form.png)
* Press "Confirm" then confirm the transaction in your wallet.

The page should update to display the amount of `SQD` you locked and the duration of the lockup:

![Lockup success](./portal_lock_success.png)

Now you have some locked tokens associated with your wallet and are ready to set up the portal itself.

#### Step 2: Wait for your stake to become active

This will happen at the beginning of the next [epoch](/subsquid-network/faq/#epoch), that is, at some point during the next 20 minutes. The page will change to show that your lockup is now active:

![Lockup active](<./portal_lock_active.png>)

#### Step 3: Generate a peer ID {#generate-peer-id}

SQD Network is a decentralized peer-to-peer system. Portals are a type of peers participating in it. Like all peers, your portal requires a private key and a public unique identifier: the *peer ID*. Generate these with
```bash
docker run --rm subsquid/rpc-node:0.2.5 keygen > <KEY_PATH>
```
The key will be written to the binary file at `<KEY_PATH>`. You will see your peer ID in the output:
```
Your peer ID: <THIS IS WHAT YOU NEED TO COPY>
```
Please copy your peer ID.

⚠️ **Note:** Please make sure that the generated file is safe and secure at `<KEY_PATH>` (i.e. it will not be deleted accidentally and cannot be accessed by unauthorized parties). [Or else](#key-loss).

#### Step 4: Register your portal {#register-peer-id}

* Go to the [portals page](https://network.subsquid.io/portals) and click the "Add portal" button.
  ![Add portal button](<./portal_registration_button.png>)
* Fill the portal registration form.
  ![Portal registration form](./portal_registration_form.png)

  If you plan to make your portal public, click the "Publicly available" switch and populate the additional fields.
  ![Portal registration form - public](./portal_registration_form_public.png)

  Once done, click "Confirm" and confirm the transaction in your wallet.

#### Step 5: Run your portal {#run-portal}

* Wait for your portal to become active.

* Clone the portal repo and enter the folder.
  ```bash
  git clone https://github.com/subsquid/query-portal
  cd query-portal
  ```
* Prepare the environment. Begin with
  ```bash
  cp config.yml.mainnet config.yml
  ```
  ```bash
  cp mainnet.env .env
  ```
  then set the path to your key file:
  ```bash
  echo KEY_PATH=<KEY_PATH> >> .env
  ```

  ⚠️ **Warning:** Be careful when supplying the path to the key you created at step 4. If you make a mistake here, a new random key will be automatically created there and your node will attempt to operate with a new (unregistered) peer ID - unsuccessfully.

* Run your portal. You can either utilize a pre-built Docker image:
  ```bash
  docker compose up -d
  ```
  or build it from source:
  ```bash
  cargo run --release
  ```

* If you're running the Docker image you can watch the logs with
  ```bash
  docker compose logs -f
  ```

## Using your portal

Assuming that you're running your portal locally, it'll expose its dataset-specific APIs at URL such as this one:
```
http://localhost:port/datasets/dataset-slug
```
You can now get any squid (e.g. one of the [templates](/sdk/how-to-start/squid-development/#templates) or [examples](/sdk/examples)), tweak it to [source data from your portal](/subsquid-network/participate/portal) and run it.

## High throughput portals

The recommended way to make a portal that can serve a large number of requests is deploy multiple portals associated with a single wallet:

1. Use a single wallet to register as many peer IDs as you need portal instances.
2. Make one `SQD` lockup for all your portal instances. See [Token locking requirements and compute units](#staking-requirements-and-compute-units) to get an idea of how large your stake should be.
3. Run portals in parallel, balancing traffic between the instances.

If you plan to automate running your portal instances, you may find [this helm chart](https://github.com/subsquid/query-portal/tree/master/chart) useful.

## Troubleshooting

#### What are the consequences of losing my key file / getting it stolen? {#key-loss}

If you lose your key file you won't be able to run your portal until you get a new one and register it.

If your key file get stolen the perpetrator will be able to cause connectivity issues for your portal, effectively causing a downtime.

If any of that happens, unregister your portal (on the ["Portals" tab of network.subsquid.io](https://network.subsquid.io/portals)), then generate a new key file and register the new portal peer ID.
